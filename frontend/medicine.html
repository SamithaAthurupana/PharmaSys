<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicines - PharmaSys</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
:root { --primary:#1E88E5; --sidebar-width:260px; }
body { font-family:'Inter',sans-serif; background:#F5F7FA; }
h1,.logo-text{ font-family:'Poppins',sans-serif; }

.sidebar{
    width:var(--sidebar-width);
    height:100vh;
    position:fixed;
    background:#fff;
    border-right:1px solid #dee2e6;
}
.nav-link{
    color:#555;
    padding:12px 20px;
    border-radius:8px;
    margin:4px 15px;
}
.nav-link:hover{ background:#f0f7ff; color:var(--primary); }
.nav-link.active{ background:var(--primary); color:#fff!important; }

.main-content{
    margin-left:var(--sidebar-width);
    padding:30px;
}
.table-card{ border:none; border-radius:15px; }
</style>
</head>

<body>

<!-- ðŸ” LOGIN CHECK -->
<script>
const user = JSON.parse(localStorage.getItem("user"));
if(!user){ window.location.href="login.html"; }
</script>

<!-- SIDEBAR -->
<div class="sidebar d-flex flex-column shadow-sm">
    <div class="p-4">
        <h4 class="logo-text text-primary m-0">ðŸ’Š PharmaSys</h4>
    </div>

    <nav class="nav flex-column flex-grow-1">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link" href="pos.html">POS</a>
        <a class="nav-link active" href="medicine.html">Medicines</a>
        <a class="nav-link" href="inventory.html">Inventory</a>
        <a class="nav-link" href="employee.html">Employees</a>
        <a class="nav-link" href="settings.html">Settings</a>
    </nav>

    <div class="p-3 border-top">
        <button onclick="logout()" class="btn btn-outline-danger w-100">Logout</button>
    </div>
</div>

<!-- MAIN -->
<div class="main-content">
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h1 class="h3 fw-bold">Medicine Management</h1>
        </div>
        <div class="col-md-6 d-flex justify-content-md-end gap-2">
            <div class="input-group w-50">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control border-start-0"
                       placeholder="Search medicines...">
            </div>
            <button class="btn btn-primary" onclick="openAddMedicine()">
                <i class="bi bi-plus-lg me-2"></i>Add New
            </button>
        </div>
    </div>

    <div class="card table-card shadow-sm overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Medicine</th>
                        <th>Category</th>
                        <th>Batch</th>
                        <th>Expiry</th>
                        <th>Stock</th>
                        <th>Price</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="medicineTableBody"></tbody>
            </table>
        </div>
        <div id="loadingSpinner" class="text-center p-5">
            <div class="spinner-border text-primary"></div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="medicineModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="medicineModalTitle">Add Medicine</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="medicineId">

        <input class="form-control mb-2" id="medName" placeholder="Medicine Name">
        <input class="form-control mb-2" id="category" placeholder="Category">
        <input class="form-control mb-2" id="batchId" placeholder="Batch ID">
        <input class="form-control mb-2" type="date" id="expiryDate">
        <input class="form-control mb-2" type="number" id="quantity" placeholder="Quantity">
        <input class="form-control mb-2" type="number" id="price" placeholder="Price">
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveMedicine()">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE="http://127.0.0.1:8000";
let medicineModal;

function logout(){
    localStorage.removeItem("user");
    window.location.href="login.html";
}

function openAddMedicine(){
    medicineModal = new bootstrap.Modal(medicineModalEl);
    medicineModalTitle.innerText="Add Medicine";
    medicineId.value="";
    medName.value="";
    category.value="";
    batchId.value="";
    expiryDate.value="";
    quantity.value="";
    price.value="";
    medicineModal.show();
}

function openEditMedicine(m){
    medicineModal = new bootstrap.Modal(medicineModalEl);
    medicineModalTitle.innerText="Edit Medicine";
    medicineId.value=m.medicine_id;
    medName.value=m.medicine_name;
    category.value=m.category;
    batchId.value=m.batch_id;
    expiryDate.value=m.expiry_date;
    quantity.value=m.quantity;
    price.value=m.price;
    medicineModal.show();
}

async function saveMedicine(){
    const payload={
        medicine_name: medName.value,
        category: category.value,
        batch_id: batchId.value,
        expiry_date: expiryDate.value,
        quantity: quantity.value,
        price: price.value
    };

    if(medicineId.value){
        await fetch(`${API_BASE}/medicines/${medicineId.value}`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(payload)
        });
        alert("Medicine updated");
    } else {
        await fetch(`${API_BASE}/medicines`,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(payload)
        });
        alert("Medicine added");
    }

    medicineModal.hide();
    loadMedicines();
}

async function loadMedicines(){
    const body=document.getElementById("medicineTableBody");
    const spinner=document.getElementById("loadingSpinner");

    try{
        const res=await fetch(`${API_BASE}/medicines`);
        const meds=await res.json();
        body.innerHTML="";
        spinner.style.display="none";

        meds.forEach(m=>{
            const stockClass = m.quantity <= 10 ? "text-danger fw-bold" : "text-success fw-bold";

            body.innerHTML+=`
            <tr>
                <td class="ps-4"><strong>${m.medicine_name}</strong></td>
                <td>${m.category}</td>
                <td>${m.batch_id}</td>
                <td>${m.expiry_date}</td>
                <td><span class="${stockClass}">${m.quantity}</span></td>
                <td>Rs. ${Number(m.price).toLocaleString()}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light text-primary"
                        onclick='openEditMedicine(${JSON.stringify(m)})'>
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            </tr>`;
        });
    }catch{
        spinner.style.display="none";
        body.innerHTML=`
        <tr>
            <td colspan="7" class="text-center text-danger p-4">
                Failed to load medicines
            </td>
        </tr>`;
    }
}

// SEARCH
document.getElementById("searchInput").addEventListener("keyup",function(){
    const filter=this.value.toUpperCase();
    const rows=document.getElementById("medicineTableBody").rows;
    for(let i=0;i<rows.length;i++){
        const name=rows[i].cells[0].innerText.toUpperCase();
        const cat=rows[i].cells[1].innerText.toUpperCase();
        rows[i].style.display =
            name.includes(filter)||cat.includes(filter) ? "" : "none";
    }
});

const medicineModalEl = document.getElementById("medicineModal");
loadMedicines();
</script>

</body>
</html>
