<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - PharmaSys</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FB;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .logo-font { font-family: 'Poppins', sans-serif; }
        .cart-items-container {
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 450px);
        }
        .search-input { border: 2px solid #1E88E5; padding: 1rem; }
        .search-input:focus { box-shadow: none; border-color: #1565C0; }
        .dashed-line { border-top: 2px dashed #dee2e6; margin: 1.5rem 0; }
        .table-med { background: white; border-radius: 10px; overflow: hidden; }
        .qty-btn { cursor: pointer; user-select: none; }
    </style>
</head>

<body>

    <header class="navbar navbar-dark bg-primary shadow-sm px-4">
        <span class="navbar-brand logo-font fw-bold"><i class="bi bi-capsule-pill me-2"></i> PharmaSys POS</span>
        <div class="text-white d-none d-md-block">
            <span class="opacity-75">Pharmacist:</span> <span class="fw-semibold">Sarah Khan</span>
            <i class="bi bi-person-circle ms-2"></i>
        </div>
    </header>

    <div class="container-fluid flex-grow-1 overflow-hidden">
        <div class="row h-100">
            
            <div class="col-lg-8 col-md-7 p-4 border-end overflow-auto h-100">
                <div class="mb-4">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-primary border-end-0 text-primary">
                            <i class="bi bi-search fs-5"></i>
                        </span>
                        <input type="text" id="medSearch" class="form-control search-input border-start-0" placeholder="Search medicine by name...">
                    </div>
                </div>

                <div class="card table-med shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Medicine Name</th>
                                    <th>Batch</th>
                                    <th>Stock</th>
                                    <th>Price</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="medicineList">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-5 bg-white p-4 d-flex flex-column shadow-lg">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                    <h5 class="logo-font mb-0">Current Cart</h5>
                    <span class="badge bg-primary rounded-pill" id="cartBadge">0 Items</span>
                </div>

                <div class="cart-items-container pe-2" id="cartContainer">
                    <div class="text-center text-muted mt-5" id="emptyCartMsg">
                        <i class="bi bi-cart3 fs-1 opacity-25"></i>
                        <p>Cart is empty</p>
                    </div>
                </div>

                <div class="mt-auto border-top pt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span class="fw-semibold" id="subtotalText">Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Discount (5%)</span>
                        <span class="text-danger fw-semibold" id="discountText">- Rs. 0.00</span>
                    </div>
                    
                    <div class="dashed-line"></div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="logo-font fw-bold text-primary mb-0">Total</h4>
                        <h4 class="logo-font fw-bold text-primary mb-0" id="totalText">Rs. 0.00</h4>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100 py-3 fw-bold" onclick="window.print()">
                                <i class="bi bi-printer me-2"></i>Print
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" onclick="completeSale()" id="payBtn" disabled>
                                <i class="bi bi-wallet2 me-2"></i>Pay Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000";
        let cart = [];
        let allMedicines = [];

        // 1. Fetch Medicines from Inventory
        async function fetchMedicines() {
            try {
                const res = await fetch(`${API_BASE}/inventory`);
                allMedicines = await res.json();
                renderMedicines(allMedicines);
            } catch (err) {
                console.error("Failed to load medicines", err);
            }
        }

        function renderMedicines(items) {
            const list = document.getElementById("medicineList");
            list.innerHTML = items.map(m => `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold">${m.medicine_name}</div>
                        <small class="text-muted">ID: ${m.id || 1}</small>
                    </td>
                    <td><span class="badge bg-light text-dark border">${m.batch_id}</span></td>
                    <td><span class="badge bg-success-subtle text-success">${m.quantity} Left</span></td>
                    <td class="fw-semibold text-primary">Rs. ${parseFloat(m.price || 10).toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-primary btn-sm px-3 shadow-sm" 
                                onclick="addToCart(${m.id || 1}, '${m.medicine_name}', ${m.price || 10})">
                            Add <i class="bi bi-plus"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 2. Cart Logic
        function addToCart(id, name, price) {
            const existing = cart.find(i => i.medicine_id === id);
            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({ medicine_id: id, name: name, price: price, quantity: 1 });
            }
            updateUI();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.medicine_id !== id);
            updateUI();
        }

        function updateUI() {
            const container = document.getElementById("cartContainer");
            const emptyMsg = document.getElementById("emptyCartMsg");
            
            if (cart.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyMsg);
                document.getElementById("payBtn").disabled = true;
            } else {
                emptyMsg.remove();
                container.innerHTML = cart.map(item => `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="fw-bold small">${item.name}</div>
                            <small class="text-muted">Rs. ${item.price} x ${item.quantity}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">Rs. ${(item.price * item.quantity).toFixed(2)}</div>
                            <small class="text-danger qty-btn" onclick="removeFromCart(${item.medicine_id})">Remove</small>
                        </div>
                    </div>
                `).join('');
                document.getElementById("payBtn").disabled = false;
            }

            // Calculations
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = subtotal * 0.05;
            const total = subtotal - discount;

            document.getElementById("subtotalText").innerText = `Rs. ${subtotal.toFixed(2)}`;
            document.getElementById("discountText").innerText = `- Rs. ${discount.toFixed(2)}`;
            document.getElementById("totalText").innerText = `Rs. ${total.toFixed(2)}`;
            document.getElementById("cartBadge").innerText = `${cart.length} Items`;
        }

        // 3. Complete Sale API Call
        async function completeSale() {
            const saleData = {
                user_id: 1, // Logged in pharmacist ID
                discount: 5,
                items: cart.map(i => ({
                    medicine_id: i.medicine_id,
                    quantity: i.quantity,
                    price: i.price
                }))
            };

            try {
                const res = await fetch(`${API_BASE}/sales`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(saleData)
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`✅ Sale Successful!\nInvoice: ${data.invoice_no}\nTotal: Rs. ${data.total_amount}`);
                    cart = [];
                    updateUI();
                    fetchMedicines(); // Refresh stock
                } else {
                    alert("❌ Sale failed. Check stock levels.");
                }
            } catch (err) {
                alert("❌ Server Error");
            }
        }

        // Search Filter
        document.getElementById("medSearch").addEventListener("input", (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allMedicines.filter(m => m.medicine_name.toLowerCase().includes(term));
            renderMedicines(filtered);
        });

        fetchMedicines();
    </script>
</body>
</html>