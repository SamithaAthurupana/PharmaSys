<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - PharmaSys</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary-color: #4361ee; --sidebar-width: 280px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f4f7fe; color: #2b3674; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: white; z-index: 1000; border-right: 1px solid #eef2f6; }
        .logo-wrapper { padding: 2.5rem 1.5rem; font-weight: 800; font-size: 1.5rem; letter-spacing: -1px; color: var(--primary-color); }
        .nav-link { color: #a3aed0; padding: 0.8rem 1.5rem; margin: 0.2rem 1rem; display: flex; align-items: center; border-radius: 12px; font-weight: 600; transition: 0.2s; text-decoration: none; }
        .nav-link:hover { background: #f4f7fe; color: var(--primary-color); }
        .nav-link.active { background: var(--primary-color); color: white !important; box-shadow: 0px 10px 20px rgba(67, 97, 238, 0.23); }

        /* Main Layout */
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; }
        .pos-card { border: none; border-radius: 20px; background: white; box-shadow: 0px 20px 40px rgba(0, 0, 0, 0.02); }
        
        /* Table Styling */
        .table thead th { background-color: #f8f9fa; text-transform: uppercase; font-size: 0.75rem; color: #a3aed0; padding: 1rem; border: none; }
        .table td { vertical-align: middle; padding: 1rem; border-bottom: 1px solid #f1f4f9; }

        /* Cart Area */
        .cart-container { position: sticky; top: 2rem; }
        .cart-item { border-bottom: 1px dashed #e0e5f2; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .cart-scroll { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .cart-scroll::-webkit-scrollbar { width: 4px; }
        .cart-scroll::-webkit-scrollbar-thumb { background: #e0e5f2; border-radius: 10px; }

        /* Components */
        .search-bar { border-radius: 15px; border: none; padding: 0.8rem 1.5rem; box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.05); }
        .qty-input { width: 80px; border-radius: 8px; border: 1px solid #e0e5f2; text-align: center; font-weight: 600; }
        .modal-content { border-radius: 25px; border: none; }
        .btn-pay { border-radius: 12px; padding: 12px; font-weight: 700; transition: 0.3s; }
        .btn-pay:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>

<body>

    <div class="sidebar d-flex flex-column shadow-sm">
        <div class="logo-wrapper"><i class="bi bi-capsule-pill me-2"></i>Pharma<span style="color: #2b3674;">Sys</span></div>
        <nav class="nav flex-column flex-grow-1">
            <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-fill me-2"></i> Dashboard</a>
            <a class="nav-link active" href="pos.html"><i class="bi bi-cart3 me-2"></i> POS</a>
            <a class="nav-link" href="medicine.html"><i class="bi bi-capsule me-2"></i> Medicines</a>
            <a class="nav-link" href="inventory.html"><i class="bi bi-archive me-2"></i> Inventory</a>
            <a class="nav-link" href="employee.html"><i class="bi bi-people me-2"></i> Employees</a>
            <a class="nav-link" href="prescription.html"><i class="bi bi-file-earmark-medical-fill me-2"></i> Prescriptions</a>
            <a class="nav-link" href="reports.html"><i class="bi bi-graph-up-arrow me-2"></i> Reports</a>
            <a class="nav-link" href="settings.html"><i class="bi bi-sliders me-2"></i> Settings</a>
        </nav>
        <div class="mt-auto p-4 border-top">
            <button onclick="logout()"
                class="btn btn-light text-danger w-100 fw-bold border-0 rounded-3">Logout</button>
        </div>
    </div>

<div class="main-content">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Checkout Point</h2>
            <p class="text-muted small">Logged in as: <span id="userName" class="fw-bold text-primary">...</span></p>
        </div>
        <div class="w-50">
            <input type="text" id="searchInput" class="form-control search-bar" placeholder="ðŸ” Search medicine name or batch...">
        </div>
    </header>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="pos-card overflow-hidden">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Medicine</th>
                            <th>Stock</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th class="text-end pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="medicineTable">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="cart-container">
                <div class="pos-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Current Order</h5>
                        <span class="badge bg-primary rounded-pill px-3" id="cartCount">0 Items</span>
                    </div>

                    <div id="cartBody" class="cart-scroll mb-4">
                        <div class="text-center py-5">
                            <i class="bi bi-cart-x fs-1 text-light"></i>
                            <p class="text-muted mt-2">No items added yet</p>
                        </div>
                    </div>

                    <div class="bg-light p-3 rounded-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted small">Subtotal</span>
                            <span class="fw-bold" id="subtotal">Rs. 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted small">Discount (5%)</span>
                            <span class="fw-bold text-danger" id="discount">- Rs. 0.00</span>
                        </div>
                        <hr class="text-muted opacity-25">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Payable Total</span>
                            <h4 class="fw-800 text-primary mb-0" id="total">Rs. 0.00</h4>
                        </div>
                    </div>

                    <div class="row g-2 mt-4">
                        <div class="col-12 mb-2">
                            <button class="btn btn-primary btn-pay w-100" id="payBtn" onclick="payNow()" disabled>
                                <i class="bi bi-shield-check me-2"></i>Complete Transaction
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-outline-secondary w-100 rounded-3 py-2 fw-bold" id="printBtn" onclick="printInvoice()" disabled>
                                <i class="bi bi-printer me-2"></i>Generate PDF Receipt
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="thankYouModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <div class="mx-auto mb-4 bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="bi bi-check-lg fs-1"></i>
            </div>
            <h3 class="fw-bold">Payment Success!</h3>
            <p class="text-muted">The transaction has been recorded and stock has been updated.</p>
            <button class="btn btn-primary px-5 py-2 rounded-pill mt-3 fw-bold" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    const API = "http://127.0.0.1:8000";
    let medicines = [];
    let cart = [];
    let thankYouModal;

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("userName").innerText = user.username;
        thankYouModal = new bootstrap.Modal(document.getElementById('thankYouModal'));
        loadMedicines();
    });

    async function loadMedicines() {
        try {
            const res = await fetch(`${API}/inventory`);
            medicines = await res.json();
            renderMedicines(medicines);
        } catch (e) { console.error("API Error:", e); }
    }

    function renderMedicines(list) {
        const table = document.getElementById("medicineTable");
        table.innerHTML = list.map(m => `
            <tr>
                <td class="ps-4">
                    <div class="fw-bold">${m.medicine_name}</div>
                    <div class="text-muted small">${m.batch_id || 'No Batch'}</div>
                </td>
                <td><span class="badge ${m.quantity < 10 ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'} rounded-pill">${m.quantity} in stock</span></td>
                <td class="fw-bold text-dark">Rs. ${Number(m.price).toFixed(2)}</td>
                <td>
                    <input type="number" min="1" max="${m.quantity}" value="1" id="qty_${m.medicine_id}" class="qty-input">
                </td>
                <td class="text-end pe-4">
                    <button class="btn btn-primary btn-sm rounded-3 px-3" onclick="addToCart(${m.medicine_id})">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Search functionality
    document.getElementById("searchInput").addEventListener("input", e => {
        const val = e.target.value.toLowerCase();
        const filtered = medicines.filter(m => 
            m.medicine_name.toLowerCase().includes(val) || 
            (m.batch_id && m.batch_id.toLowerCase().includes(val))
        );
        renderMedicines(filtered);
    });

    window.addToCart = function(id) {
        const med = medicines.find(m => m.medicine_id === id);
        const qty = parseInt(document.getElementById(`qty_${id}`).value);

        if (qty <= 0 || qty > med.quantity) return alert("Insufficient stock!");

        const existing = cart.find(i => i.medicine_id === id);
        if (existing) existing.quantity += qty;
        else cart.push({ medicine_id: id, name: med.medicine_name, price: med.price, quantity: qty });

        updateCart();
    };

    window.removeItem = function(id) {
        cart = cart.filter(i => i.medicine_id !== id);
        updateCart();
    };

    function updateCart() {
        const cartBody = document.getElementById("cartBody");
        if (cart.length === 0) {
            cartBody.innerHTML = `<div class="text-center py-5 text-muted">Cart is empty</div>`;
            document.getElementById("payBtn").disabled = document.getElementById("printBtn").disabled = true;
        } else {
            cartBody.innerHTML = cart.map(i => `
                <div class="cart-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold small">${i.name}</div>
                        <div class="text-muted smaller">Qty: ${i.quantity}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold small">Rs. ${(i.price * i.quantity).toFixed(2)}</div>
                        <i class="bi bi-trash text-danger small cursor-pointer" onclick="removeItem(${i.medicine_id})"></i>
                    </div>
                </div>
            `).join('');
            document.getElementById("payBtn").disabled = document.getElementById("printBtn").disabled = false;
        }

        const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
        const discount = subtotal * 0.05;
        const total = subtotal - discount;

        document.getElementById("subtotal").innerText = `Rs. ${subtotal.toFixed(2)}`;
        document.getElementById("discount").innerText = `- Rs. ${discount.toFixed(2)}`;
        document.getElementById("total").innerText = `Rs. ${total.toFixed(2)}`;
        document.getElementById("cartCount").innerText = `${cart.length} Items`;
    }

    window.payNow = async function() {
        const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
        const discount = subtotal * 0.05;
        const payload = {
            user_id: user.user_id,
            discount: discount,
            total_amount: subtotal - discount,
            items: cart
        };

        try {
            const res = await fetch(`${API}/sales`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                thankYouModal.show();
                cart = [];
                updateCart();
                loadMedicines();
            } else { alert("Payment error. Check logs."); }
        } catch (e) { alert("Server connection failed."); }
    };

    window.printInvoice = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold");
        doc.text("PHARMASYS RECEIPT", 105, 20, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Date: ${new Date().toLocaleString()}`, 20, 30);
        doc.text(`Pharmacist: ${user.username}`, 20, 35);
        
        let y = 50;
        doc.text("Item", 20, y);
        doc.text("Qty", 120, y);
        doc.text("Total", 160, y);
        doc.line(20, y+2, 190, y+2);
        
        y += 10;
        cart.forEach(i => {
            doc.text(i.name, 20, y);
            doc.text(i.quantity.toString(), 120, y);
            doc.text(`Rs. ${(i.price * i.quantity).toFixed(2)}`, 160, y);
            y += 8;
        });

        const total = document.getElementById("total").innerText;
        doc.setFont("helvetica", "bold");
        doc.text(`GRAND TOTAL: ${total}`, 160, y + 10, { align: "right" });
        doc.save(`Receipt_${Date.now()}.pdf`);
    };

    function logout() {
        localStorage.removeItem("user");
        window.location.href = "login.html";
    }
</script>
</body>
</html>